# KoroMind Claude Voice Assistant - Docker Compose
#
# Quick start:
#   cp docker/koro.env.example docker/koro.env
#   # Edit docker/koro.env with your API keys
#   docker-compose up -d
#
# Logs:
#   docker-compose logs -f koro
#
# Authentication options:
#   1. API Key: Set ANTHROPIC_API_KEY in docker/koro.env
#   2. Subscription: Uncomment the credentials mount below after running 'claude /login' on host

services:
  koro:
    build: .
    container_name: claude-voice-koro
    profiles: ["telegram"]
    env_file:
      - .env
    volumes:
      # Dirs from .env
      # work dir
      - ${HOME}/claude-work-dir:/claude-work-dir
      # sandbox dir
      - ${HOME}/claude-voice-sandbox:/claude-voice-sandbox
      # Persistent state (session history, user settings)
      - koro-state:/home/claude/state
      # Sandbox for Claude file operations
      - koro-sandbox:/home/claude/sandbox
      # Prompts directory (read-only)
      - ./src/prompts:/home/claude/app/src/prompts:ro
      # Claude credentials persistence
      - koro-claude-config:/home/claude/.claude
      # OPTIONAL: Mount host credentials for subscription users
      # Uncomment after running 'claude /login' on your host machine
      # - ~/.claude/.credentials.json:/home/claude/.claude/.credentials.json:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "python.*bot.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Helper to generate uv.lock without local Python

  koro-api:
    build: .
    container_name: claude-voice-koro-api
    profiles: ["api"]
    env_file:
      - .env
    command: ["uvicorn", "koro.api.app:app", "--host", "0.0.0.0", "--port", "8420"]
    ports:
      - "8420:8420"
    volumes:
      - koro-state:/home/claude/state
      - koro-sandbox:/home/claude/sandbox
      - ./src/prompts:/home/claude/app/src/prompts:ro
      - koro-claude-config:/home/claude/.claude
    restart: unless-stopped

  uv-lock:
    image: python:3.12-slim-bookworm
    working_dir: /repo
    volumes:
      - .:/repo
    entrypoint: ["/bin/sh", "-lc"]
    command: "pip install --no-cache-dir uv && uv lock"

volumes:
  koro-state:
  koro-sandbox:
  koro-claude-config:
